{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/YardenZamir/sim-chat/schemas/dialogue.schema.json",
  "title": "SimChat Dialogue",
  "description": "Schema for SimChat dialogue entries used in datapacks",
  "type": "object",
  "required": ["entityId", "entityName", "text"],
  "properties": {
    "entityId": {
      "type": "string",
      "description": "Unique identifier for the entity. Used for conversation grouping and avatar lookup (loads from config/simchat/entities/<entityId>.png)",
      "minLength": 1
    },
    "entityName": {
      "type": "string",
      "description": "Display name shown in chat and sidebar. Supports templates with {compile:...} or {runtime:...}.",
      "minLength": 1
    },
    "entitySubtitle": {
      "type": "string",
      "description": "Optional subtitle shown next to name (e.g., company, title, affiliation). Supports templates with {compile:...} or {runtime:...}."
    },
    "text": {
      "oneOf": [
        {
          "type": "string",
          "description": "Message content displayed in the chat.",
          "minLength": 1
        },
        {
          "type": "array",
          "description": "Multiple text variants. Selection controlled by textMode.",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 1
        }
      ],
      "description": "Message content displayed in the chat. Can be a single string or array of variants. Supports templates with {compile:...} or {runtime:...}."
    },
    "textMode": {
      "$ref": "#/$defs/variantMode",
      "description": "How to select from text variants. Default: random."
    },
    "actions": {
      "type": "array",
      "description": "Response buttons shown below the message",
      "items": {
        "type": "object",
        "required": ["label"],
        "properties": {
          "id": {
            "type": "string",
            "description": "Action identifier. Required when using sequential/sequential_cycle modes for label or reply variants.",
            "minLength": 1
          },
          "label": {
            "oneOf": [
              {
                "type": "string",
                "description": "Button text.",
                "minLength": 1
              },
              {
                "type": "array",
                "description": "Multiple label variants. Selection controlled by labelMode.",
                "items": { "type": "string", "minLength": 1 },
                "minItems": 1
              }
            ],
            "description": "Button text. Can be a single string or array of variants. Supports templates with {compile:...} or {runtime:...}."
          },
          "labelMode": {
            "$ref": "#/$defs/variantMode",
            "description": "How to select from label variants. Default: random."
          },
          "commands": {
            "type": "array",
            "description": "Commands to execute when clicked (in order). Supports templates with {compile:...} or {runtime:...}.",
            "items": {
              "type": "string"
            },
            "default": []
          },
          "reply": {
            "oneOf": [
              {
                "type": "string",
                "description": "Player's reply text shown in chat when button is clicked."
              },
              {
                "type": "array",
                "description": "Multiple reply variants. Selection controlled by replyMode.",
                "items": { "type": "string" },
                "minItems": 1
              }
            ],
            "description": "Player's reply text shown in chat when button is clicked. Can be a single string or array of variants. Supports templates with {compile:...} or {runtime:...}."
          },
          "replyMode": {
            "$ref": "#/$defs/variantMode",
            "description": "How to select from reply variants. Default: random."
          },
          "nextState": {
            "type": "string",
            "description": "Dialogue resource location to auto-send after this action (e.g., 'mypack:npc/next'). Triggers typing delay then delivers the next dialogue automatically.",
            "pattern": "^[a-z0-9_.-]+:[a-z0-9_./]+$"
          },
          "condition": {
            "type": "string",
            "description": "Condition that must pass for this action to be visible. Supports prefixes: 'kjs:callbackName' (KubeJS callback), 'flag:flagName' (team flag), 'score:objectiveName' (scoreboard > 0), 'permission:level' (op level). Prefix with '!' to negate.",
            "examples": ["kjs:hasHighRep", "!flag:seen_intro", "score:playerKills", "permission:2"]
          },
          "itemsVisual": {
            "type": "array",
            "description": "Items displayed on the button (visual only, gray background)",
            "items": { "$ref": "#/$defs/itemSpec" }
          },
          "itemsInput": {
            "type": "array",
            "description": "Items required from player inventory - consumed on click (blue background)",
            "items": { "$ref": "#/$defs/itemSpec" }
          },
          "itemsOutput": {
            "type": "array",
            "description": "Items given to player on click (orange background)",
            "items": { "$ref": "#/$defs/itemSpec" }
          },
          "playerInput": {
            "oneOf": [
              {
                "type": "string",
                "description": "Variable name (shorthand form with defaults: maxLength=64, no pattern, saveAsData=false)",
                "minLength": 1
              },
              {
                "type": "object",
                "required": ["id"],
                "properties": {
                  "id": {
                    "type": "string",
                    "description": "Variable name, accessible via {input:id} in reply/commands",
                    "minLength": 1
                  },
                  "maxLength": {
                    "type": "integer",
                    "description": "Maximum input length",
                    "minimum": 1,
                    "maximum": 256,
                    "default": 64
                  },
                  "pattern": {
                    "type": "string",
                    "description": "Regex pattern for validation (Java regex syntax). Input is colored green/red based on match."
                  },
                  "error": {
                    "type": "string",
                    "description": "Tooltip shown when input doesn't match pattern"
                  },
                  "saveAsData": {
                    "type": "boolean",
                    "description": "If true, saves input to team data as data:<id>",
                    "default": false
                  }
                }
              }
            ],
            "description": "Transforms action into text input field. Value available via {input:id} template in reply/commands."
          }
        }
      }
    }
  },
  "$defs": {
    "variantMode": {
      "type": "string",
      "enum": ["random", "sequential", "sequential_cycle"],
      "default": "random",
      "description": "Variant selection mode. 'random': pick randomly each time. 'sequential': advance through list, stick on last. 'sequential_cycle': advance through list, wrap around. Sequential modes require action 'id' to be set."
    },
    "itemSpec": {
      "type": "object",
      "required": ["id"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Item ID with optional NBT (e.g., 'minecraft:diamond', 'minecraft:diamond{display:{Name:\"Cool\"}}')"
        },
        "count": {
          "type": "integer",
          "description": "Item count",
          "minimum": 1,
          "maximum": 64,
          "default": 1
        }
      }
    }
  },
  "examples": [
    {
      "entityId": "contractor",
      "entityName": "Director Vex",
      "entitySubtitle": "Helion Industries",
      "text": "We need 200 plasma conduits. Military-grade shielding. 5,000 credits on delivery.",
      "actions": [
        {
          "label": "I'll take it",
          "nextState": "mypack:contractor/accept",
          "reply": "Send the specifications.",
          "itemsVisual": [
            {"id": "minecraft:copper_ingot", "count": 64}
          ]
        },
        {
          "label": "Not interested",
          "nextState": "mypack:contractor/decline",
          "reply": "Find someone else."
        }
      ]
    },
    {
      "entityId": "merchant",
      "entityName": "Trader Bob",
      "text": "Want to buy a sword?",
      "actions": [
        {
          "label": "Buy Iron Sword",
          "reply": "I'll take one.",
          "itemsInput": [{"id": "minecraft:emerald", "count": 10}],
          "itemsOutput": [{"id": "minecraft:iron_sword", "count": 1}],
          "nextState": "mypack:merchant/thanks"
        }
      ]
    },
    {
      "entityId": "mayor",
      "entityName": "Mayor Thompson",
      "text": "Welcome to our town! What should I call you?",
      "actions": [
        {
          "label": "Enter your name",
          "playerInput": {
            "id": "playerName",
            "maxLength": 32,
            "pattern": "^[a-zA-Z ]+$",
            "error": "Name must contain only letters and spaces",
            "saveAsData": true
          },
          "reply": "My name is {input:playerName}.",
          "commands": ["simchat team title {input:playerName}'s Party"],
          "nextState": "mypack:mayor/welcome_named"
        }
      ]
    },
    {
      "$comment": "Example with text variants and sequential mode",
      "entityId": "greeter",
      "entityName": "Village Elder",
      "text": ["Hello, traveler!", "Welcome back!", "Good to see you again!"],
      "textMode": "sequential_cycle",
      "actions": [
        {
          "id": "greet_back",
          "label": ["Hello!", "Hi there!", "Greetings!"],
          "labelMode": "random",
          "reply": ["Hello to you too.", "Nice to meet you.", "Good day."],
          "replyMode": "sequential"
        }
      ]
    }
  ]
}
